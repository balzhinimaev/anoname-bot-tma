# Система сбора пользователей для рассылки

## Описание

Бот теперь автоматически собирает ID всех пользователей, которые нажимают `/start`, в файл `user_ids.txt`. Это позволяет проводить рассылки даже тем пользователям, которые не зарегистрировались в мини-приложении.

## Как это работает

1. **Автоматический сбор**: При нажатии `/start` ID пользователя автоматически сохраняется в файл `user_ids.txt`
2. **Защита от дубликатов**: Система проверяет, не был ли пользователь уже добавлен ранее
3. **Логирование**: В консоли отображается информация о добавлении новых пользователей

## Файлы

- `user_ids.txt` - файл с ID пользователей (создается автоматически)
- `broadcast.js` - скрипт для просмотра собранных ID пользователей

## Использование

### Просмотр собранных пользователей

```bash
node broadcast.js "Тестовое сообщение"
```

### Получение списка через API

```bash
curl -H "X-API-Key: YOUR_BOT_BACKEND_SECRET" http://localhost:7777/users
```

Ответ:
```json
{
  "count": 5,
  "userIds": ["123456789", "987654321", "555666777"]
}
```

## Для рассылки сообщений

Чтобы отправить сообщения всем пользователям, вам нужно:

1. Получить список ID из файла или API
2. Использовать Telegram Bot API для отправки сообщений каждому пользователю
3. Обработать ошибки (заблокированные боты, несуществующие пользователи и т.д.)

### Пример кода для рассылки

```javascript
const { Telegraf } = require('telegraf');

async function broadcastMessage(message) {
  const bot = new Telegraf(process.env.BOT_TOKEN);
  const userIds = await readUserIds();
  
  for (const userId of userIds) {
    try {
      await bot.telegram.sendMessage(userId, message);
      console.log(`Message sent to ${userId}`);
    } catch (error) {
      console.error(`Failed to send to ${userId}:`, error.message);
    }
  }
}
```

## Безопасность

- Эндпоинт `/users` защищен секретным ключом `BOT_BACKEND_SECRET`
- Файл `user_ids.txt` содержит только ID пользователей, без личной информации
- Рекомендуется регулярно создавать резервные копии файла

## Мониторинг

В логах бота вы увидите сообщения типа:
- `[user_ids] Добавлен новый пользователь: 123456789`
- `[user_ids] Пользователь уже существует: 123456789`
